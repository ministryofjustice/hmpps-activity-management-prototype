{% extends "layout_hmpps.html" %}

{% set serviceName = "Activities Management" %}
{% set activitiesCount = activitiesForDate.morning|length + activitiesForDate.afternoon|length %}

{% block pageTitle %}
Find an activity to record or edit attendance
{% endblock %}

{% block primaryNavigation %}
{% endblock %}

{% block main %}
<form method="post">
    <div class="govuk-width-container">
        {% block beforeContent %}
        {% include "./_activity-breadcrumbs.html" %}
        {% endblock %}

        <main class="govuk-main-wrapper govuk-main-wrapper--auto-spacing" id="main-content" role="main">
            {% block content %}
            {% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
            {% if data['confirmation-dialog'].display == true %}

            {% set prisoner = data['confirmation-dialog'].prisoner | getPrisonerDetails %}

            {% if data['confirmation-dialog'].type == 'deallocate' %}
            {% set bannerHtml %}
            <h2 class="govuk-notification-banner__heading">
                {{prisoner.name.firstname}} {{prisoner.name.surname}} is no longer allocated to {{activity.name}}.
            </h2>
            {% endset %}
            {{ govukNotificationBanner({
            html: bannerHtml,
            titleText: "Success",
            type: "success"
            }) }}
            {% endif %}
            {% endif %}

            {% include "./_activity-header.html" %}

            <table class="govuk-table govuk-!-margin-bottom-5" data-module="moj-multi-select"
                data-multi-select-checkbox="#select-all">
                <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header">Prisoner details</th>
                        <th scope="col" class="govuk-table__header">Non-associations in this prison</th>
                        <th scope="col" class="govuk-table__header">Start / end date</th>
                        <th scope="col" class="govuk-table__header">Pay rate</th>
                        <th scope="col" class="govuk-table__header">Earliest release date</th>
                        <th scope="col" class="govuk-table__header"></th>
                    </tr>
                </thead>
                <tbody class="govuk-table__body">
                    {% for prisoner in currentlyAllocated | sort(false,true,'name.surname') %}
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">
                            <b>
                                <a href="#" class="govuk-link--no-visited-state">
                                    {{prisoner.name.surname}}, {{prisoner.name.firstname}}
                                </a>
                            </b>
                            <br>
                            {{prisoner.id}}
                            <br>
                            {{prisoner.location.cell}}
                        </td>
                        <td class="govuk-table__cell">
                            {% if loop.index == 3 %}
                            <ul class="govuk-list">
                                <li><a href="#" class="govuk-link--no-visited-state">Jordan Johnson-Jones</a>
                                </li>
                            </ul>
                            <!-- <details class="govuk-details" data-module="govuk-details">
                                <summary class="govuk-details__summary">
                                    <span class="govuk-details__summary-text">
                                        3 non associations
                                    </span>
                                </summary>
                                <div class="govuk-details__text">
                                    <ul class="govuk-list">
                                        <li><a href="#" class="govuk-link--no-visited-state">Jordan Johnson-Jones</a>
                                        </li>
                                    </ul>
                                </div>
                            </details> -->
                            {% else %}
                            None
                            {% endif %}
                        </td>
                        <td class="govuk-table__cell">
                            {{prisoner.allocations[prisoner.activityIndex].startDate|convertShortDateToMediumDate}}
                            {% if prisoner.allocations[prisoner.activityIndex].endDate %}
                            <br>
                            to {{prisoner.allocations[prisoner.activityIndex].endDate|convertShortDateToMediumDate}}
                            {% endif %}
                        </td>
                        <td class="govuk-table__cell">
                            Â£1.40 - Skilled
                        </td>
                        <td class="govuk-table__cell">
                            {{prisoner.releaseDate|convertShortDateToMediumDate}}
                        </td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">
                            <a href="allocation/{{prisoner.id}}" class="govuk-link--no-visited-state">View or change</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- {{govukButton({
            text: "Remove from activity",
            classes: "govuk-button--warning"
            })}} -->

            {% endblock %}
        </main>
    </div>

    {% include '../includes/allocation-toolbar.html' %}
</form>
{% endblock %}


{% block pageScripts %}
<script type="text/javascript">
    // toggle .app-attendance-sticky-bar--bottom toolbar to display when any table checkboxes are checked
    // ... and hide when no checkboxes are checked
    const toolbar = $('#allocation-toolbar');
    const checkbox = $('table').find('input[type="checkbox"]');
    const selectedCount = $('#app-selected-count');
    const clearButton = $('#clear-selection');

    selectedCount.attr('data-html', $('#app-selected-count').html());

    const generateCountString = (count) => {
        let noun = count == 1 ? ' person' : ' people';
        return count + noun + ' selected';
    }

    function updateToolbar() {
        if (checkbox.is(':checked')) {
            toolbar.addClass('active').attr("aria-disabled", false);
            selectedCount.html(generateCountString(checkbox.filter(':checked').length));
        } else {
            toolbar.removeClass('active').attr("aria-disabled", true);
            selectedCount.html(selectedCount.attr('data-html'));
        }
    };

    $('body').on('change', 'table input[type="checkbox"]', updateToolbar);

    // run the function on window load to check if any checkboxes are already checked
    $(window).on('load', updateToolbar);

    clearButton.on('click', function (event) {
        event.preventDefault();
        let selectAllCheckbox = $('body').find('table input[type="checkbox"]').first();
        // if the first checkbox in the table is checked, uncheck it
        if (selectAllCheckbox.is(':checked')) {
            selectAllCheckbox.click();
        } else {
            // otherwise, uncheck all other checkboxes
            checkbox.prop('checked', false);
        }
        toolbar.removeClass('active').attr("aria-disabled", true);
        selectedCount.html(selectedCount.attr('data-html'));
    });

</script>
{% endblock %}